---
title: "FishErIes Size and functional TYpe model (FEISTY) in R"
author: "Ken H Andersen and Karline Soetaert"
date: " 2024"
output:
  pdf_document:
    latex_engine: pdflatex
    keep_tex: true
vignette: >
  %\VignetteIndexEntry{FishErIes Size and functional TYpe model (FEISTY) in R}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
bibliography: references.bib
link-citations: yes
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
if (!require(FEISTY)) devtools::install_github("Kenhasteandersen/FEISTY@R-Package")
library(FEISTY)
palette("ggplot2")  # ggplot2-style palette
```

# Introduction

The R package **FEISTY** is to document the FEITY model and for further
model development and research. This document mainly describes the
FEISTY model scheme and indicates the corresponding functions in R implementation [@petrik2019bottom; @van2021emergent].


# The structure of main parameters

Several functions to create suitable parameter inputs are included:

-   setupBasic creates a basic three-species setup as described in
    Petrik et al (2019)
-   setupBasic2 creates a basic three-species setup as setupBasic(), but
    generalised to: more realistic sizes, Generalized size-based
    feeding, the possiblity of more then 3 size groups in each group
-   setupVertical makes a basic four-species setup that distinguishes
    between visual and twilight predators and that includes vertical
    distribution of zooplankton
-   setupPelagicSpecies makes a basic setup with just pelagic fish, and
    with feeding preferences according to the size ratios of predators
    and prey.

blabla

## Example

The model is first run with the default 3-functional group prameters,
created with *setupBasic()*. Then two similar parameter datasets are
created, with rates doubled or halved.

```{r}
p <- setupBasic()
knitr::kable(p$resources, digits=2)
knitr::kable(p$fishes, digits=2)
knitr::kable(p$groups, digits=2)
```

Function *paramAddPhysiology* is used to change the allometric rates:

```{r}
p2 <- paramAddPhysiology(p, ac = 40, am = 8, ae=140)

p3 <- paramAddPhysiology(p, ac = 10, am = 2, ae=35)
```

The model can now be run for all parameter sets; the reulst for the last
20 years are shown.

```{r, fig.width=8, fig.height=8}
out1 <- simulateFEISTY(p=p,  times=seq(0, 200, length.out=1000),bCust=T)
out2 <- simulateFEISTY(p=p2, times=seq(0, 200, length.out=1000),bCust=T)
out3 <- simulateFEISTY(p=p3, times=seq(0, 200, length.out=1000),bCust=T)
# plot(out1, out2, out3, which=5:12, lty=1, lwd=2, subset=time>180)
# plot(out1, out2, out3, which=c("smallZoo", "largeZoo", "smallBenthos", 
#   "totBiomass.smallPel", "totBiomass.largePel",  "totBiomass.Demersals"), 
#   lty=1, lwd=2, subset=time>180)
```

\newpage

# The FEISTY model

## Size spectrum

The fish size span of a functional type is logarithmically discretized
into $n$ continuous size bins. Each size bin shares the same ratio $z$
between the upper boundary size and lower boundary size:
\begin{equation}
z = \exp \left( \frac{\ln (w_{max}) - \ln (w_{min})}{n} \right)
\end{equation} 
where $w_{min}$ and $w_{max}$ are smallest and largest fish in a functional type. There are $n+1$ boundaries of $n$ size bins, including all lower boundary sizes ($m_{l,i}$) and upper boundary sizes ($m_{u,i}$). 
\begin{equation}
m_{b,i} =  \exp( \ln(w_{min}) + (i-1) \ln(z)), \hspace{1.5cm}  i\in[1,n+1]
\end{equation} 
\begin{equation}
m_{l,i} =  m_{b,i}, \hspace{5.5cm}  i\in[1,n]
\end{equation}
\begin{equation}
m_{u,i} =  m_{b,i+1}, \hspace{5.1cm}  i\in[1,n]
\end{equation}
The geometric meansize of each size class $m_{i}$ is:
\begin{equation}
m_{i} =  \exp ( \ln(m_{l,i}) + 0.5(\ln(z)) ), \hspace{2.2cm}  i\in[1,n]
\end{equation}
which will be comprehensively used for calculations, for instance,
physiological rates and size-based feeding preference.\
The size spectrum generation is done by calling the function
`paramAddGroup()`. Also, see the source code of `makeGrid()`.

## Biomass dynamics

### Fish dynamics

The biomass of each size class of a functional type of fish ($B_i$,
$gWW~ m^{-2}$) changes over time ($t$) according to source and sink of
energy [@deRoos2008; @petrik2019bottom]:
\begin{equation}
\dfrac{dB_{i}}{dt} =  J_{in,i}  + (\nu_{i} - \rho_i -\mu_i)B_i - J_{out,i},
\end{equation}
where $\nu_{i}$ is the rate of available energy for growth and
reproduction, $\rho_i$ is the rate of reproduction, and $\mu_i$
($year^{-1}$) is the total mortality rate. The size of fish increases as
a result of growth. The grown fish biomass fluxes out of the current
size class to the next size class (excluding the largest fish). The
energy fluxing out of a size class $i$ is 
\begin{equation}
J_{out,i} = \gamma_i B_i,
\end{equation}
where $\gamma_i$ represents the growth rate ($year^{-1}$). The energy
fluxing in a size class includes two part for the smallest fish and
other sizes, respectively: 
\begin{equation}
    J_{in,i} =
  \begin{cases}
\epsilon_r \left(  J_{out,n} + \sum\limits_i \rho_i B_i \right),      & \text{$ i=1 $} \\
     J_{out,i-1}, & \text{$ i > 1$} 
  \end{cases}
\end{equation} 
where $\epsilon_r$ is the reproduction efficiency. The energy fluxing
into the smallest fish class ($i=1$) is from the reproduction of each
size class of fish that can reproduce and the energy fluxing out of the
largest fish class ($J_{out,n}$) because it cannot grow larger. For
larger fish ($i > 1$), the energy fluxing into the size class $i$ is
from the growth of the previous neighboring size class ($i-1$).

### Resource dynamics

The resource $i$ biomass evolves over time according to a chemostat-like
growth and a consumption by predators, which is the default resource
dynamic mode in four internal setups [@petrik2019bottom;
@van2021emergent]:

\begin{equation}
\dfrac{dR_{i}}{dt} =  r(K_i - R_i ) - \mu_{p,i} R_i,
\end{equation}

where $R$ is the state variable of a resource, $K$ is the carry capacity
($gWW ~ m^{-2}$), and $r$ is the growth rate which is constant value
($1~year^{-1}$). $\mu_{p}$ represents the predation mortality on a
resource. Alternatively, we provide the logistic growth strategy for
resources:

\begin{equation}
\frac{dR_i}{dt}=r_i \cdot R_i \cdot (1-\frac{R_i}{K_i}) - \mu_{p,i} \cdot R_i,
\end{equation}
which can be set in `paramAddResource()` function.

## Physiological rate

In the FEISTY model, there are three main biological rates based on the
allometric scaling relationship of the body size (ref?). The
mass-specific maximum consumption rate $C_{max,i}$ ($year^{-1}$), the
mass-specific clearance rate $V_{i}$ ($m^{2}~gWW^{-1}~year^{-1}$), and the
mass-specific metabolic rate $M_i$ ($year^{-1}$) for each fish size
class are temperature-dependent:
\begin{equation}
C_{max,i} = k_{T} \cdot a_{c} \cdot m_{i}^{b_{c}}  \label{eq:maxconsump}
\end{equation}
\begin{equation}
V_{i} = k_{T} \cdot a_{e} \cdot m_{i}^{b_{e}}      \label{eq:clearance}
\end{equation}
\begin{equation}
M_i = k_{TM} \cdot a_{m} \cdot m_{i}^{b_{m}}       \label{eq:metabolism}
\end{equation}
where $k_{T}$ and $k_{TM}$
are scaling factors of temperature effects (see Section **Temperature
effects**). $a_{c}$, $a_{e}$, and $a_{m}$ are intercepts of each
biological rate, respectively; $b_{c}$, $b_{e}$, $b_{m}$ are exponents.
These biological rates determine the energy gained from predation and
costs due to basal metabolism (see Section **Energy budget**).\
In code implementation, these basic biological rates of fish (without
temperature effects) are assigned by the `paramAddPhysiology()` function.
The temperature effects on biological rates are added subsequently (see
Section **Temperature effects**).

## Energy budget

For a given size of fish $i$, the mass-specific available energy for
growth or reproduction (rate) $\nu_{i}$ is the result of the
mass-specific energy from assimilated food (rate) minus the
mass-specific metabolic rate:
\begin{equation}
\nu_{i} = \epsilon_\alpha f_i C_{max,i} - M_i
\end{equation}
where $\epsilon_\alpha$ is the assimilation efficiency. The mass-specific
feeding level $f_i$ (dimensionless) describes how much food a predator
can eat relative to the maximum consumption capability, ranging from 0
to 1: 
\begin{equation}
f_{i} = \frac{E_{i}}{E_{i}+C_{max,i}}
\end{equation}
Therefore, the mass-specific consumption rate $f_i C_{max,i}$ is based on type II
functional response. The feeding behavior of a predator is a consequence
of encountering prey. The mass-specific encounter rate ($year^{-1}$)
$E_{i}$ of a predator $i$ is:
\begin{equation}
E_{i} = V_{i}  \sum_{j} \theta_{i,j} B_j,
\end{equation}
where $\theta_{i,j}$
denotes the feeding preference of a predator $i$ on a prey $j$ (see
Section **?**). $B_j$ represents the biomass of a prey $j$ including
zooplankton, benthos or fish. Therefore, the $\sum_{j} \theta_{i,j} B_j$
represents the biomass of all available prey of a predator.

# Reproduction and growth

When the assimilated energy is still surplus after meeting the demand of
the basal metabolism, fish can conduct growth and reproduction. The
reproductive rate ($year^{-1}$) of each size class of fish is:
\begin{equation}
\rho_i =
  \begin{cases}
 \psi_i \nu_i, & \text{$ \nu_i > 0 $}   \\
     0, & \text{$ \nu_i \leq 0 $} 
  \end{cases}
\end{equation}
$\psi_i$ is the maturity level (dimensionless) of fish $i$,
describing the proportion of available energy ($\nu_{i}$) used in the
reproduction process. It can be either assigned with constants manually
(setupBasic and setupVertical [@petrik2019bottom; @van2021emergent]) or
by a sigmoid function (setupBasic2 and setupVertical2):
\begin{equation}
\psi_i = \left(1+\left(\frac{m_{c,i}}{m_{mature}}\right)^{-5} \right)^{-1}
\end{equation}
$m_{mature}$ is the half-maturation size of a functional type, which
means fish reach 50% maturity level at $m_{mature}$.
\begin{equation}
m_{mature} = \eta_{mature} w_{max}
\end{equation}
where $\eta_{mature}$ is the
coefficient determining the half-maturation size relative to the max
size of a functional type.

The rest fraction of the available energy $\nu_{i}$ is invested in
growth: 
\begin{equation}
\kappa_i = 1 - \psi_i
\end{equation}
The growth rate of a specific size
class $i$ is: 
\begin{equation}
 \gamma_i =
  \begin{cases}
\frac{ \kappa_i \nu_i - \mu_i }{1-(1/z)^{1-\mu_i/\kappa_i \nu_i}}, & \text{$ \nu_i > 0 $}   \\
     0, & \text{$ \nu_i \leq 0 $} 
  \end{cases}
\end{equation}
The detail can be found in [@deRoos2008]. $\mu_i$ is the total
mortality including the predation mortality rate ($\mu_{p,i}$),
background mortality rate ($\mu_{p,i}$), and fishing mortality rate
($\mu_{f,i}$): 
\begin{equation}
\mu_i = \mu_{p,i}+\mu_{b,i}+\mu_{f,i}
\end{equation}
All size classes of fish a same background mortality rate value within a
functional group and the default value is 0.1 $year^{-1}$. The details of
predation and fishing are in the sections below.

# Predation

In the non-vertical distribution version (setupBasic and setupBasic2)
$\theta_{i,j}$ refers to the feeding preference based on the size
preference. The value of $\theta_{i,j}$ can be assigned manually
(setupBasic, see Table 2 in [@petrik2019bottom]). It also can be
calculated following functions either based on the log-normal
distribution:

\begin{equation}
 \theta_{i, j} =
  \begin{cases}
\exp\left( -\frac{\left(\log\left(\frac{m_{c,i}}{\beta \cdot m_{c,j}}\right)\right)^2}{(2 \cdot \sigma)^2} \right), & \text{$ m_{i} > m_{j} $}   \\
     0, & \text{$ m_{i} \leq m_{j} $} 
  \end{cases}
\label{eq:lognormalpreference}
\end{equation}

or based on the error function [@van2021emergent]: ????????? 
\begin{equation}
\theta_{i, j} = \frac{\sqrt{\frac{\pi}{2}} \cdot \sigma \cdot \left( \text{erf}\left(\frac{\log(m_{u,j}) - \log\left(\frac{m_{c,i}}{\beta}\right)}{\sqrt{2} \cdot \sigma}\right) - \text{erf}\left(\frac{\log(m_{l,j}) - \log\left(\frac{m_{c,i}}{\beta}\right)}{\sqrt{2} \cdot \sigma}\right) \right)}{\log(m_{u,j}) - \log(m_{l,j})}
\label{eq:errorpreference}
\end{equation}
$\beta$ is preferred predator-prey mass ratio, and $\sigma$ is the
size preference width for feeding. The size-preference function
selection and the values of $\beta$ and $\sigma$ can be defined by the
function `paramSizepref()`.

In vertical distribution version, $\theta_{i,j}$ is the product of
size-based preference ($\theta_{s,i,j}$) and vertical overlap ($\theta_{v,i,j}$):
\begin{equation}
\theta_{i,j} = \theta_{s,i,j} \cdot\theta_{v,i,j} 
\end{equation}
The calculation of $\theta_{s,i,j}$ follows Eq. \ref{eq:lognormalpreference} in setupVertical and Eq. \ref{eq:errorpreference} in setupVertical2. The detailed description of $\theta_{v,i,j}$ in the Section **Vertical overlap**.

Once the feeding preference is ready, the predation mortality of a prey
$j$ can be calculated:
\begin{equation}
\mu_{p,j} = \sum_i  \frac{V_i \theta_{i,j}  B_i}{E_i+C_{max,i}} C_{max,i}
\end{equation}

In practice, the feeding preference setting is more complex, since it plays a vital role in the coexistence of various functional types. when the feeding preference $\theta_{i,j}$ is initially calculated as a function (e.g., Eq. \ref{eq:lognormalpreference}), sometimes it needs to be revised or corrected manually according to specific rules, such as cannibalism, habitats, feeding habits, and visibility. Here I introduce how the feeding preference $\theta_{i,j}$ is further processed in setupBasic2.

Forage fish and large pelagic fish live in the pelagic zone during their whole lifetime. Demersal fish habitats are different in terms of their sizes and water depth. Small demersal fish are pelagic status while medium demersal fish are benthic-living. Pelagic-living organisms do not interact with benthic-living organisms and vice versa.

**Forage fish**\
The feeding preference from forage fish and large pelagic fish to benthic resources and medium demersal fish are corrected to 0.

**Large pelagic fish**\
The feeding preference from large pelagic fish to benthic resources and medium demersal fish is corrected to 0.
Large pelagic fish have reduced feeding preference on forage fish ($\theta_A \cdot \theta_{i,j}$).

**Demersal fish**\
The feeding preference from small demersal fish to benthic resources is corrected to 0.\
Medium demersal fish only feed on benthos and themselves (cannibalism). Therefore, their feeding preference on zooplankton and all fish excluding themselves is corrected to 0.\
In shallow water ($<~200 m$), large demersal fish swim over the water column, meaning they can eat both pelagic and benthic organisms. Their feeding preference on forage fish was down-regulated: $\theta_A \cdot \theta_D \cdot \theta_{i,j}$. Their feeding preference on large pelagic fish was down-regulated: $\theta_D \cdot \theta_{i,j}$.\
When water is deep ($>~200 m$), large demersal fish is fully benthic-living. So the feeding preference of large demersals on all pelagic prey is corrected to 0, including forage fish, large pelagic fish, zooplankton, and small demersal fish. They only can feed on benthos, medium demersals, and themselves.


# Vertical overlap

**To be done...**




# Fishing

The fishing mortality rate $\mu_{f,i}$ of a particular size class of
fish $i$ can be either determined by constant values or by a fishing
selectivity function ??????: 
\begin{equation}
\mu_{f,i}=\psi_{f,i}F
\end{equation}
where $F$ is the baseline fishing mortality rate ($year^{-1}$) of a functional type of
fish. $\psi_{f,i}$ denotes the size-based fishing selectivity following
a sigmoid function:
\begin{equation}
\psi_{f,i} = \left(1+\left(\frac{m_{c,i}}{m_{fishing}}\right)^{-3} \right)^{-1}
\end{equation}
where $m_{fishing}$ indicates the fish with this size is under 50%
harvesting rate. The fishing mortality rate can be assigned by the
function `setFishing()`.

# Temperature effects
The temperature effects on the mass-specific maximum consumption rate $C_{max,i}$, the mass-specific clearance rate $V_{i}$, and the mass-specific metabolic rate $M_i$ (Eq. \ref{eq:maxconsump}, \ref{eq:clearance}, \ref{eq:metabolism}) are based on the use of $Q_{10}$ coefficient, which describes the exponential variation of rates every 10\textdegree{}C.

The general equation for the temperature scaling factor $k$ is:
\begin{equation}
k = Q_{10}^{\frac{T-T_{ref}}{10}} \label{eq:Tscfac}
\end{equation}
where $T_{ref}$ is the reference temperature and $T$ is the environment temperature.
According to the different functional types of fish and their sizes, fish habitats change. For fish staying in the pelagic zone, $T=T_p$ (e.g., all forage fish); for fish always in the benthic zone $T=T_b$ (e.g., medium-size demersal fish). $k_{T}$ is temperature scaling factor for $C_{max,i}$ and $V_{i}$; $k_{TM}$ is temperature scaling factor for $M_i$. To calculate them, different $Q_{10}$ factors are required (Table xx). The temperature effects on biological rates are done by the function `paramTeffect()`. Note this function only works on non-vertical distribution setups, i.e., setupBasic and setupBasic2. Technically, it also can be used in customized setups.

In setupBasic and setupBasic2, there are three functional types of fish: forage fish (small pelagic fish), large pelagic fish, and demersal fish. Forage fish and large pelagics are always in the pelagic water, so the $T_p$ is consistently applied. Demersal fish habitats change according to size. Small demersal is in a pelagic status ($T_p$). Medium demersals live at the bottom ($T_b$). Large demersals also stay in the bottom if the water is deep ($>~200 m$). However, in shallow water ($<~200 m$), due to their better swimming abilities, the large demersals migrate over the water column for feeding. To better describe the temperature effects on large demersals, the effective temperature is introduced (see
Section **Effective temperature**).

In setupVertical, fish have a new trait axis of vertical distribution.

T profile
The implementation is hard-coded, embedded in the function `setupVertical()`

To simplify the temperature input, three temperature inputs ($T_p$, $T_m$, $T_b$) are required rather than the water column temperature profile in setupVertical2. 

The implementation is hard coded in the function `setupVertical2()`

**To be done...**

## Effective temperature
Following [@petrik2019bottom], in shallow water ($<~200 m$) the large demersal fish ($m_{c,i}>250~gWW$ as default)
migrate vertically within a day rather than staying at the bottom constantly. They are assumed to spend a fraction of time $\lambda$ in the pelagic zone and the rest of time $1-\lambda$ at the bottom according to the abundance of prey in these two zones.
\begin{equation}
\lambda = \frac{B_{pelprey}}{B_{allprey}}
\end{equation}
where $B_{pelprey}$ denotes the total biomass of pelagic prey for large demersal fish, $B_{allprey}$ is the total biomass of all prey for large demersal fish. A simple case can be found in Eq. 15 in [@petrik2019bottom].\
Therefore, the temperature for large demersals is defined based on their time spent in the pelagic zone and benthic zone, which is called effective temperature:
\begin{equation} 
T_e = T_p \cdot \lambda + T_b \cdot (1 - \lambda)
\end{equation}
$T_e$ is updated each time step during the time integration, along with the temperature-dependent biological rates, which are handled by the function `updateET()`. In code implementation, `updateET()` is called every time step in `derivativesFEISTYR()`. The effective temperature scheme is forced turned on in `setupBasic()` [@petrik2019bottom]; it is an option in `setupBasic2()`.


# Default parameters

| Symbol       | Explaination | Value| | | | Unit |
|--------------|----------------------------------------------------|--|--|--|--|------|
|              |                                                    |w|e|r|f|          |
|   $a_c$   |Intercept for mass-specific maximum consumption rate| 10    |aaa|aaa|
|   $b_c$   |Exponent for mass-specific maximum consumption rate | 20    |aaa|aaa|
|   $a_e$   |Intercept for mass-specific clearance rate||
|   $b_e$   |Exponent for mass-specific clearance rate||
|   $a_m$   |Intercept for mass-specific metabolism rate||
|   $b_m$   |Exponent for mass-specific metabolism rate| 30    |aaa|aaa|

\begin{table}[htbp]

\centering
\caption{Main parameters of FEISTY}

\begin{tabular}{lp{8cm}lp{1cm}lp{1cm}lp{1cm}lp{1cm}l}
\hline
Symbol & Description & \multicolumn{4}{c}{Value} & Unit \\
                         \cline{3-6}
       &             & B1 & B2 & V1 & V2         &  \\
\hline
Parameter 1 & xxx & \multicolumn{4}{c}{value123} & aaa \\
$a_c$ & Intercept for mass-specific maximum consumption rate & 0.1 & 0.2 & 0.3 & 0.4 & gWW \\
$b_c$ & Exponent for mass-specific maximum consumption rate & \\
$a_e$ & Intercept for mass-specific clearance rate &  &  & & & $m^2 g^{-b_{e}}yr^{-1}$ \\
$b_e$ & Exponent for mass-specific clearance rate & 0.1 & 0.2 & 0.3 & 0.4 & gWW \\
$a_m$ & Intercept for mass-specific metabolism rate & 0.1 & 0.2 & 0.3 & 0.4 & gWW \\
$b_m$ & Exponent for mass-specific metabolism rate & 0.1 & 0.2 & 0.3 & 0.4 & gWW \\
$aaa$ & xxx & 0.1 & 0.2 & 0.3 & 0.4 & gWW \\
$aaa$ & xxx & 0.1 & 0.2 & 0.3 & 0.4 & gWW \\
$aaa$ & xxx & 0.1 & 0.2 & 0.3 & 0.4 & gWW \\
$aaa$ & xxx & 0.1 & 0.2 & 0.3 & 0.4 & gWW \\
$aaa$ & xxx & 0.1 & 0.2 & 0.3 & 0.4 & gWW \\
$aaa$ & xxx & 0.1 & 0.2 & 0.3 & 0.4 & gWW \\
$aaa$ & xxx & 0.1 & 0.2 & 0.3 & 0.4 & gWW \\
$aaa$ & xxx & 0.1 & 0.2 & 0.3 & 0.4 & gWW \\
$aaa$ & xxx & 0.1 & 0.2 & 0.3 & 0.4 & gWW \\
\hline
\multicolumn{7}{l}{\footnotesize $^a$ B1: setupBasic1, B2: setupBasic2, V1: setupVertcal1, V2: setupVertcal2.} \\
\multicolumn{7}{l}{value123}
\end{tabular}
\end{table}


# References

\bibliography{references.bib}
